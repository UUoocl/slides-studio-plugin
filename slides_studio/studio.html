<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slides.com studio</title>
    <style>
        .container {
            position: relative;
            overflow: hidden;
            width: 500px;
            padding-top: 281.25px; /* 16:9 Aspect Ratio (divide 9 by 16 = 0.5625) */
        }

        /* Then style the iframe to fit in the container div with full height and width */
        .responsive-iframe {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
        }

        /* 2 column form grid layout         */
        .form-grid {
            display:grid;
            grid-template-columns: 350px 150px;
        }

        .form-button{
            padding: 2px;
            margin: 10px 10px 0 0;
        }
        
        .slide-location{
            width: 500px
        }
    </style>
     <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet" />
   
</head>
<body>

    <form>
        <label for="slideDeckId">slide deck name</label> 
        <input class= "slide-location" type="text" id="slideDeckId" name="slideDeckId"
        placeholder="deck-id" />
        <button type="button" id="slideDeckIdLoadButton" class="form-button">Load</button>
    </form>
        <div id="slidesTable">
            <h3>Slides settings</h3>
    </div>
 
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script src='lib/setupTable.js'></script>
 
    <script>
        let slideDeckId;
        const iframe = document.getElementById("slidesDeck");
        let slideStateObj = {};
        let slidesArray;
        let dropDownOptions = {};
        
        window.addEventListener("DOMContentLoaded", (event) => {
            console.log("studio iframe page is fully loaded");
            //get OBS details from parent
            getOBSdata();
            getSlidesData();
        })
        
        function getOBSdata(){
            sendMessageToParent({namespace: "tabulator", message: "obs-data"}, window.location.origin)
        }

        function getSlidesData(){
            sendMessageToParent({namespace: "tabulator", message: "slides-data"}, window.location.origin)
        }

        function sendMessageToParent(message, origin) {
            // Send the message to the parent window
            window.parent.postMessage(JSON.stringify(message), origin);
        }

        //messages from parent window
        window.addEventListener("message", async (event) => {
            if (event.origin === window.location.origin) {
                console.log(event)
                let data = JSON.parse(event.data);
                console.log(data)

                //select row on slide change
                if (data.namespace === "speakerview" && data.message === "change-row") {
                    console.log("chnage row", data)
                    let stateString;
                    
                    stateString = `${data.state.indexh},${data.state.indexv}`;
                    
                    console.log(stateString)
                    
                    table.selectRow(0)
                    
                    let row = table.searchData("slideState", "=", stateString);
                    let rowComponent = table.searchRows("slideState", "=", stateString);
                    console.log(row[0])
                    // console.log(rowComponent[0].getIndex())
                    console.log(rowComponent[0].getPosition())
                    table.deselectRow();
                    table.selectRow(table.getRowFromPosition(rowComponent[0].getPosition()));
                    table.scrollToRow(rowComponent[0], "top")
                    
                    //select fragment
                    if (data.state.hasOwnProperty("indexf")) {
                        stateString = `${data.state.indexh},${data.state.indexv},${data.state.indexf}`;
                        let children = rowComponent[0].getTreeChildren()
                        console.log(children)
                        console.log(children[0]._row.data.slideState, stateString)
                        console.log(children[0]._row.data.slideState === stateString)
                        const fragmentRow = children.filter(row => row._row.data.slideState === stateString)
                        console.log(fragmentRow)
                        table.selectRow(table.getRowFromPosition(fragmentRow[0].getPosition()));
                        const rowData = fragmentRow[0].getData();
                        filterRowData(rowData);
                    } else {
                        const rowData = rowComponent[0].getData();
                        filterRowData(rowData);
                    }

                }
            
            //slide data from speakerView
            if(data.namespace === "speakerview" && data.message === "slides-data-response"){
                console.log("slide data response arrived")
                slidesArray = data.slidesData    
                console.log(slidesArray)
                loadTable();
            }  
            
            //obs data from speakerView
            if(data.namespace === "speakerview" && data.message === "obs-data-response"){
                console.log("obs data response arrived")
                dropDownOptions = { ... data.obsData }   
                console.log(JSON.stringify(dropDownOptions))
                loadTable();
            }  
        }
        })

            document
                .getElementById("slideDeckId")
                .addEventListener('change', updateSlideName);

            document
                .getElementById("slideDeckIdLoadButton")
                .addEventListener('click', loadSavedTable);

        //button functions            
        function updateSlideName() {
            slideDeckId = document.getElementById("slideDeckId").value;
            console.log("SlideID", slideDeckId)
        }

        function loadSavedTable() {
            let localSavedTable = localStorage.getItem(slideDeckId);
            localSavedTable = JSON.parse(localSavedTable)
            loadTable();
        }
    </script>

</body>
</html>